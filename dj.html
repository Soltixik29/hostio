<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ Pult</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.26/Tone.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bpm-detective"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body { background: #121212; color: white; text-align: center; font-family: 'Arial', sans-serif; }
        .container { margin-top: 20px; }
        .deck { padding: 20px; border-radius: 10px; background: #1e1e1e; box-shadow: 0 0 15px rgba(0, 255, 255, 0.2); }
        .deck h3 { color: cyan; }
        .controls button { margin: 5px; font-size: 20px; }
        .slider { width: 100%; }
        .crossfader { width: 100%; margin-top: 10px; }
        .waveform { width: 100%; height: 100px; background: black; margin-top: 10px; }
        .info { font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

    <h1><i class="fas fa-music"></i> DJ Pult</h1>

    <div class="container">
        <div class="row">
            <!-- Deck 1 -->
            <div class="col-md-5 deck">
                <h3><i class="fas fa-record-vinyl"></i> Deck 1</h3>
                <input type="file" id="file1">
                <div class="waveform" id="wave1"></div>
                <div class="info">
                    <span id="time1">00:00 / 00:00</span> | <span id="bpm1">BPM: --</span>
                </div>
                <div class="controls">
                    <button class="btn btn-success" onclick="playDeck(1)"><i class="fas fa-play"></i></button>
                    <button class="btn btn-danger" onclick="stopDeck(1)"><i class="fas fa-stop"></i></button>
                </div>
                <label>Pitch: <input type="range" id="pitch1" class="slider" min="0.5" max="2" step="0.01" value="1" onchange="changePitch(1)"></label>
            </div>

            <!-- Crossfader -->
            <div class="col-md-2">
                <h3><i class="fas fa-sliders-h"></i> Crossfader</h3>
                <input type="range" id="crossfader" class="crossfader" min="0" max="1" step="0.01" value="0.5" onchange="updateCrossfader()">
            </div>

            <!-- Deck 2 -->
            <div class="col-md-5 deck">
                <h3><i class="fas fa-record-vinyl"></i> Deck 2</h3>
                <input type="file" id="file2">
                <div class="waveform" id="wave2"></div>
                <div class="info">
                    <span id="time2">00:00 / 00:00</span> | <span id="bpm2">BPM: --</span>
                </div>
                <div class="controls">
                    <button class="btn btn-success" onclick="playDeck(2)"><i class="fas fa-play"></i></button>
                    <button class="btn btn-danger" onclick="stopDeck(2)"><i class="fas fa-stop"></i></button>
                </div>
                <label>Pitch: <input type="range" id="pitch2" class="slider" min="0.5" max="2" step="0.01" value="1" onchange="changePitch(2)"></label>
            </div>
        </div>
    </div>

    <script>
        let wavesurfers = {
            1: WaveSurfer.create({ container: '#wave1', waveColor: 'cyan', progressColor: 'blue', interact: true, backend: 'MediaElement' }),
            2: WaveSurfer.create({ container: '#wave2', waveColor: 'magenta', progressColor: 'red', interact: true, backend: 'MediaElement' })
        };

        let players = {
            1: new Tone.Player().toDestination(),
            2: new Tone.Player().toDestination()
        };

        function playDeck(deck) {
            let fileInput = document.getElementById('file' + deck);
            if (fileInput.files.length > 0) {
                let file = URL.createObjectURL(fileInput.files[0]);
                wavesurfers[deck].load(file);
                players[deck].load(file).then(() => {
                    players[deck].playbackRate = document.getElementById('pitch' + deck).value;
                    players[deck].start();
                    updateTime(deck);
                    detectBPM(file, deck);
                });
            }
        }

        function stopDeck(deck) {
            players[deck].stop();
            wavesurfers[deck].stop();
        }

        function changePitch(deck) {
            players[deck].playbackRate = document.getElementById('pitch' + deck).value;
        }

        function updateCrossfader() {
            let value = document.getElementById('crossfader').value;
            players[1].volume.value = Tone.gainToDb(1 - value);
            players[2].volume.value = Tone.gainToDb(value);
        }

        function updateTime(deck) {
            setInterval(() => {
                let currentTime = formatTime(wavesurfers[deck].getCurrentTime());
                let totalTime = formatTime(wavesurfers[deck].getDuration());
                document.getElementById('time' + deck).innerText = `${currentTime} / ${totalTime}`;
            }, 500);
        }

        function detectBPM(file, deck) {
            fetch(file)
                .then(response => response.arrayBuffer())
                .then(data => {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    return audioCtx.decodeAudioData(data);
                })
                .then(decodedData => {
                    const bpm = BPMDetective(decodedData);
                    document.getElementById('bpm' + deck).innerText = `BPM: ${Math.round(bpm)}`;
                })
                .catch(error => console.error('Chyba BPM detekce:', error));
        }

        function formatTime(seconds) {
            let mins = Math.floor(seconds / 60);
            let secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
    </script>

</body>
</html>
